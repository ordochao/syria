<!DOCTYPE html>
<meta charset="utf-8">
<link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="styles/main.css" rel="stylesheet" media="screen">
<body >
	<script src="http://d3js.org/d3.v2.min.js"></script>
	<script src="lib/colorbrewer.js"></script>
    <script src="lib/topojson.js"></script>
    <script src="lib/cartogram.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="lib/bootstrap/js/bootstrap.min.js"></script>
    <script src="scripts/dataManager.js"></script>
    <script src="scripts/syriaCartogram.js"></script>
    <script src="scripts/colorManager.js"></script>
    <!-- Application Structure-->
    <h1 class="title">THE SYRIAN CIVIL WAR</h1>
	<div id="mapCanvas" >
	</div>
	<nav class="mapNavigator">
	    	<div class="inline controls" >	 
				<button type = "button" class="frameToFrameButton" onclick="previousStep()"><</button>
				<span id="monthDisplayer">Month 0</span>		
				<button type = "button" class="frameToFrameButton" onclick="nextStep()">></button>
			</div>  
	 </nav>	    	
<script>

var width = 525,
    height = 525;

var currentStep = 0;

var svg = d3.select("#mapCanvas").append("svg")
			.attr("width", width)
			.attr("height", height)
			.attr("class", "map");


init = function () {
	window.cartogram.init();
	loadData();
}

tooltip = d3.select("body")
	.append("div")
	.style("position", "absolute")
	.style("z-index", "10")
	.style("visibility", "hidden")
	.text("a simple tooltip");

loadData = function () {
	$('body').on(window.dataManager.LOADED_DATA_EVENT, dataLoadedHandler);
    dataManager.loadData();
}

dataLoadedHandler = function(event) {
	window.colorManager.init(window.dataManager.maxCasualties);
	features = window.cartogram.getFeatures(currentStep);	
	states = svg.selectAll("path").data(features)
	.enter().append("path")
	.attr("d",window.cartogram.carto.path)
          .attr("fill", function(d) {
          	if (d.properties == undefined) {
            	return 0;
            }
            var currentValue=d.properties.monthlyValues[currentStep];
            currentColor=window.colorManager.getColor(currentValue);            
            console.log("value = "+currentValue+ " color = "+currentColor);
            return output;            
          })
}

nextStep = function () {	
	currentStep = (currentStep + 1)%23;
	console.log("Step="+currentStep);
	refreshMonths();
	refreshJson();
}

previousStep = function () {	
	currentStep = (currentStep - 1);
	if (currentStep < 0) currentStep = 22;
	console.log("Step="+currentStep);
	refreshMonths();
	refreshJson();
}

refreshMonths = function () {
	d3.select("#monthDisplayer").text("Month "+currentStep);
}

refreshJson = function () {
		
		//features = carto(window.dataManager.topology,window.dataManager.governorates).features;
		features = window.cartogram.getFeatures(currentStep);
		states.data(features).transition()
          .duration(750)
          .ease("linear")
          .attr("fill", function(d) {
          	if (d.properties == undefined) {
            	return 0;
            }
            var currentValue=d.properties.monthlyValues[currentStep];
            currentColor=window.colorManager.getColor(currentValue);            
            console.log("value = "+currentValue+ " color = "+currentColor);
            return output;            
          })
          .attr("d", window.cartogram.carto.path)         

          /*.on("mouseover", function(){
          	console.log("Mouse over")
          	return tooltip.style("visibility", "visible");})
		  .on("mousemove", function(){return tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");})
	 	  .on("mouseout", function(){return tooltip.style("visibility", "hidden");});*/
}

init();
</script>